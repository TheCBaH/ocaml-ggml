open Ctypes
open Gpt_2.C

let keep x = ignore (Sys.opaque_identity (List.hd [ x ]))

let%expect_test "gpt2" =
  let model = make Types.model_t in
  let n_ctx = 1024 in
  let n_gpu_layers = 0 in
  let fname = "models/gpt-2-117M/ggml-model.bin" in
  let rc = Functions.model_init (addr model) fname n_ctx n_gpu_layers in
  assert (rc = 0);
  [%expect {| gpt2_model_load: using CPU backend |}];

  let n_past = 0 in
  let n_tokens = 768 in

  let gpt2 = Functions.model_graph (addr model) n_past n_tokens in
  assert (not @@ Ctypes.is_null gpt2);
  let nodes = Ggml.C.Functions.graph_n_nodes gpt2 in
  Format.printf "nodes:%u" nodes;
  [%expect {| nodes:487 |}];

  let nodes = Array.init nodes (fun n -> Ggml.C.Functions.graph_node gpt2 n) in
  let names = Array.map (fun t -> Ggml.C.Functions.op_name @@ !@(t |-> Ggml.C.Types.Tensor.op)) nodes in

  Format.printf "@[%a@]" (Format.pp_print_list ~pp_sep:Format.pp_print_newline Format.pp_print_string)
  @@ Array.to_list names;
  [%expect
    {|
    GET_ROWS
    GET_ROWS
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    VIEW
    VIEW
    CPY
    VIEW
    VIEW
    CPY
    VIEW
    RESHAPE
    PERMUTE
    CONT
    VIEW
    RESHAPE
    PERMUTE
    VIEW
    CONT
    PERMUTE
    MUL_MAT
    SCALE
    DIAG_MASK_INF
    SOFT_MAX
    MUL_MAT
    PERMUTE
    CONT
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    UNARY
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    VIEW
    VIEW
    CPY
    VIEW
    VIEW
    CPY
    VIEW
    RESHAPE
    PERMUTE
    CONT
    VIEW
    RESHAPE
    PERMUTE
    VIEW
    CONT
    PERMUTE
    MUL_MAT
    SCALE
    DIAG_MASK_INF
    SOFT_MAX
    MUL_MAT
    PERMUTE
    CONT
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    UNARY
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    VIEW
    VIEW
    CPY
    VIEW
    VIEW
    CPY
    VIEW
    RESHAPE
    PERMUTE
    CONT
    VIEW
    RESHAPE
    PERMUTE
    VIEW
    CONT
    PERMUTE
    MUL_MAT
    SCALE
    DIAG_MASK_INF
    SOFT_MAX
    MUL_MAT
    PERMUTE
    CONT
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    UNARY
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    VIEW
    VIEW
    CPY
    VIEW
    VIEW
    CPY
    VIEW
    RESHAPE
    PERMUTE
    CONT
    VIEW
    RESHAPE
    PERMUTE
    VIEW
    CONT
    PERMUTE
    MUL_MAT
    SCALE
    DIAG_MASK_INF
    SOFT_MAX
    MUL_MAT
    PERMUTE
    CONT
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    UNARY
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    VIEW
    VIEW
    CPY
    VIEW
    VIEW
    CPY
    VIEW
    RESHAPE
    PERMUTE
    CONT
    VIEW
    RESHAPE
    PERMUTE
    VIEW
    CONT
    PERMUTE
    MUL_MAT
    SCALE
    DIAG_MASK_INF
    SOFT_MAX
    MUL_MAT
    PERMUTE
    CONT
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    UNARY
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    VIEW
    VIEW
    CPY
    VIEW
    VIEW
    CPY
    VIEW
    RESHAPE
    PERMUTE
    CONT
    VIEW
    RESHAPE
    PERMUTE
    VIEW
    CONT
    PERMUTE
    MUL_MAT
    SCALE
    DIAG_MASK_INF
    SOFT_MAX
    MUL_MAT
    PERMUTE
    CONT
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    UNARY
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    VIEW
    VIEW
    CPY
    VIEW
    VIEW
    CPY
    VIEW
    RESHAPE
    PERMUTE
    CONT
    VIEW
    RESHAPE
    PERMUTE
    VIEW
    CONT
    PERMUTE
    MUL_MAT
    SCALE
    DIAG_MASK_INF
    SOFT_MAX
    MUL_MAT
    PERMUTE
    CONT
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    UNARY
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    VIEW
    VIEW
    CPY
    VIEW
    VIEW
    CPY
    VIEW
    RESHAPE
    PERMUTE
    CONT
    VIEW
    RESHAPE
    PERMUTE
    VIEW
    CONT
    PERMUTE
    MUL_MAT
    SCALE
    DIAG_MASK_INF
    SOFT_MAX
    MUL_MAT
    PERMUTE
    CONT
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    UNARY
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    VIEW
    VIEW
    CPY
    VIEW
    VIEW
    CPY
    VIEW
    RESHAPE
    PERMUTE
    CONT
    VIEW
    RESHAPE
    PERMUTE
    VIEW
    CONT
    PERMUTE
    MUL_MAT
    SCALE
    DIAG_MASK_INF
    SOFT_MAX
    MUL_MAT
    PERMUTE
    CONT
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    UNARY
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    VIEW
    VIEW
    CPY
    VIEW
    VIEW
    CPY
    VIEW
    RESHAPE
    PERMUTE
    CONT
    VIEW
    RESHAPE
    PERMUTE
    VIEW
    CONT
    PERMUTE
    MUL_MAT
    SCALE
    DIAG_MASK_INF
    SOFT_MAX
    MUL_MAT
    PERMUTE
    CONT
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    UNARY
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    VIEW
    VIEW
    CPY
    VIEW
    VIEW
    CPY
    VIEW
    RESHAPE
    PERMUTE
    CONT
    VIEW
    RESHAPE
    PERMUTE
    VIEW
    CONT
    PERMUTE
    MUL_MAT
    SCALE
    DIAG_MASK_INF
    SOFT_MAX
    MUL_MAT
    PERMUTE
    CONT
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    UNARY
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    VIEW
    VIEW
    CPY
    VIEW
    VIEW
    CPY
    VIEW
    RESHAPE
    PERMUTE
    CONT
    VIEW
    RESHAPE
    PERMUTE
    VIEW
    CONT
    PERMUTE
    MUL_MAT
    SCALE
    DIAG_MASK_INF
    SOFT_MAX
    MUL_MAT
    PERMUTE
    CONT
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT
    ADD
    UNARY
    MUL_MAT
    ADD
    ADD
    NORM
    MUL
    ADD
    MUL_MAT |}];

  Functions.model_uninit (addr model);
  keep model;
  ()
